---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getMultipleOsuUsers } from "../utils/osuApi";

const base = import.meta.env.BASE_URL;

const playerOsuIds = [
  4881251,   // Lasseh
  2546001,   // Intercambing
  11786864,  // siiphs
  5339515,   // Mathi
  13058814,  // Renscereol
  5386106,   // Deruz
  11022739,  // sarondres
  5298487,   // MonkiDonki
  5619615,   // Nixiaa
  1603962,   // Touche
  36679874,  // yoistr
  11207004,  // tfge
  18946207,  // nekore
  6194830,   // Shiny Froakie
  7963246,   // BlackModerm10
];

const socialLinks: Record<number, { twitter: string; twitch: string }> = {
  4881251: { twitter: "https://x.com/lasseh__", twitch: "https://www.twitch.tv/lassseh" },
  2546001: { twitter: "https://x.com/intercambing", twitch: "https://www.twitch.tv/intercambing_" },
  11786864: { twitter: "https://x.com/siiphs", twitch: "https://www.twitch.tv/siiphs" },
  5339515: { twitter: "https://x.com/mathi501", twitch: "https://www.twitch.tv/mathi" },
  13058814: { twitter: "https://x.com/iSaneDraven", twitch: "https://www.twitch.tv/xuyidd" },
  5386106: { twitter: "https://x.com/Deruz_", twitch: "https://www.twitch.tv/deruz" },
  11022739: { twitter: "https://x.com/sarondres3", twitch: "https://www.twitch.tv/sarondres" },
  5298487: { twitter: "https://x.com/MonkiDonkii", twitch: "https://www.twitch.tv/MonkiDonki" },
  5619615: { twitter: "https://x.com/nixiaa", twitch: "https://www.twitch.tv/nixiaaa" },
  1603962: { twitter: "https://x.com/tuxe_", twitch: "https://www.twitch.tv/tulimonnn" },
  36679874: { twitter: "https://x.com/yoistr_", twitch: "https://www.twitch.tv/yoistr" },
  11207004: { twitter: "https://x.com/turtl17", twitch: "https://www.twitch.tv/tfgestu" },
  18946207: { twitter: "https://x.com/notnekore", twitch: "https://www.twitch.tv/nekorecl" },
  6194830: { twitter: "https://x.com/ShinyFroakie4", twitch: "https://www.twitch.tv/shinyfroakkie" },
  7963246: { twitter: "https://x.com/BlackModerm", twitch: "https://www.twitch.tv/blackmoderm" },
};

let osuUsers: any[] = [];
try {
  osuUsers = await getMultipleOsuUsers(playerOsuIds);
} catch (error) {
  console.error('Error fetching osu! users:', error);
}

const players = osuUsers.map((user: any, index: number) => {
  const social = socialLinks[user.id] || { twitter: "", twitch: "" };
  
  return {
    id: index + 1,
    name: user.username,
    photo: user.avatar_url,
    rank: `#${user.statistics.global_rank?.toLocaleString() || '???'}`,
    chile: `#${user.statistics.country_rank?.toLocaleString() || '???'}`,
    pp: `${Math.floor(user.statistics.pp || 0).toLocaleString()}pp`,
    accuracy: `${user.statistics.hit_accuracy?.toFixed(2) || '???'}%`,
    perfil: `https://osu.ppy.sh/users/${user.id}`,
    twitter: social.twitter,
    twitch: social.twitch,
  };
});
---

<BaseLayout 
  title="Torre del Mago - Participantes"
  description="Conoce a los 17 players invitados del team a participar por el torneo!"
  image="playersbg.png"
>
  <section class="max-w-7xl mx-auto px-6 py-12">
    <h1 class="text-5xl font-bold text-center mb-12 font-space-mono text-[var(--color-text)]">
      Participantes
    </h1>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
      <div class="order-2 lg:order-1">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
          {players.map((player, index) => (
            <div 
              class="player-card cursor-pointer transform transition-all duration-300 hover:scale-110"
              data-player-id={player.id}
              data-selected={index === 0 ? "true" : "false"}
            >
              <div class="relative rounded-lg overflow-hidden shadow-lg">
                <img 
                  src={player.photo} 
                  alt={player.name}
                  class="w-full h-32 object-cover"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex items-end">
                  <h3 class="text-white font-semibold text-xs p-2 w-full text-center">
                    {player.name}
                  </h3>
                </div>
                <!-- Borde de selecciÃ³n -->
                <div class="selection-border absolute inset-0 border-4 border-transparent transition-all duration-300"></div>
              </div>
            </div>
          ))}
        </div>
      </div>

<div class="order-1 lg:order-2 lg:sticky lg:top-24">
  <div class="relative">
    <img 
      src={`${base}planilla.png`} 
      alt="Player Stats Sheet" 
      class="w-full rounded-lg shadow-2xl"
    />
    
    <div class="absolute inset-0">
      <img 
        id="selectedPlayerPhoto"
        src={players[0].photo}
        alt="Selected Player"
        class="absolute w-32 h-32 rounded-full object-cover border-4 border-[var(--color-accent)] shadow-lg"
        style="top: 15%; left: 8%;"
      />

      <h2 
        id="selectedPlayerName" 
        class="absolute text-3xl font-bold font-space-mono text-[var(--color-text)]"
        style="top: 32%; right: 19%; transform: rotate(-3deg);"
      >
        {players[0].name}
      </h2>

      <div class="absolute" style="top: 55.2%; left: 25%; transform: rotate(-3deg);">
        <span id="selectedPlayerRank" class="font-bold font-space-mono text-xl">{players[0].rank}</span>
      </div>
      
      <div class="absolute" style="top: 54.4%; left: 47.5%; transform: rotate(-3deg);">
        <span id="selectedPlayerRankChile" class="font-bold font-font-space-mono text-xl">{players[0].chile}</span>
      </div>

      <div class="absolute" style="top: 53.4%; left: 67%; transform: rotate(-3deg);">
        <span id="selectedPlayerPP" class="font-bold font-font-space-mono text-xl">{players[0].pp}</span>
      </div>
      
      <div class="absolute" style="top: 37%; right: 19%; transform: rotate(-3deg);">
        <span id="selectedPlayerAccuracy" class="font-bold font-space-mono text-2xl">{players[0].accuracy}</span>
      </div>
      
      <div id="perfilContainer" class="absolute" style="top: 66.6%; left: 30%; transform: rotate(-3deg);">
        <a id="selectedPlayerPerfil" href={players[0].perfil} target="_blank" class="hover:opacity-80 transition">
          <img src={`${base}forum-icon.svg`} alt="Perfil" class="w-11 h-11" />
        </a>
      </div>

      <div id="twitterContainer" class="absolute" style="top: 67%; left: 20%; transform: rotate(-3deg);">
        <a id="selectedPlayerTwitter" href={players[0].twitter} target="_blank" class="hover:opacity-80 transition">
          <img src={`${base}twitter-icon.svg`} alt="Twitter" class="w-12 h-12" />
        </a>
      </div>

      <div id="twitchContainer" class="absolute" style="top: 66%; left: 39%; transform: rotate(-3deg);">
        <a id="selectedPlayerTwitch" href={players[0].twitch} target="_blank" class="hover:opacity-80 transition">
          <img src={`${base}twitch-icon.svg`} alt="Twitch" class="w-12 h-12" />
        </a>
      </div>
    </div>
  </div>
</div>

    </div>
  </section>
</BaseLayout>

<style>
  .player-card[data-selected="true"] .selection-border {
    border-color: var(--color-accent);
    box-shadow: 0 0 20px var(--color-accent);
  }

  .player-card:hover .selection-border {
    border-color: rgba(107, 78, 255, 0.5);
  }

  .player-card {
    position: relative;
  }

  .player-card[data-selected="true"]::after {
    content: '';
    position: absolute;
    inset: -4px;
    background: linear-gradient(45deg, var(--color-accent), transparent);
    border-radius: 0.5rem;
    opacity: 0.3;
    z-index: -1;
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse {
    0%, 100% {
      opacity: 0.3;
    }
    50% {
      opacity: 0.6;
    }
  }
</style>

<script define:vars={{ players }}>
  const playerCards = document.querySelectorAll('.player-card');

  playerCards.forEach(card => {
    card.addEventListener('click', () => {
      const playerId = parseInt(card.dataset.playerId);
      const player = players.find(p => p.id === playerId);
      
      if (player) {

        playerCards.forEach(c => c.dataset.selected = "false");
        
        card.dataset.selected = "true";
        
        const elements = {
          photo: document.getElementById('selectedPlayerPhoto'),
          name: document.getElementById('selectedPlayerName'),
          rank: document.getElementById('selectedPlayerRank'),
          chile: document.getElementById('selectedPlayerRankChile'),
          pp: document.getElementById('selectedPlayerPP'),
          accuracy: document.getElementById('selectedPlayerAccuracy'),
          perfil: document.getElementById('selectedPlayerPerfil'),
          twitter: document.getElementById('selectedPlayerTwitter'),
          twitch: document.getElementById('selectedPlayerTwitch')
        };

        const socialContainers = {
          perfil: document.getElementById('perfilContainer'),
          twitter: document.getElementById('twitterContainer'),
          twitch: document.getElementById('twitchContainer')
        };

        // Efecto fade
        Object.values(elements).forEach(el => {
          if (el) {
            el.style.opacity = '0';
            el.style.transform = 'translateY(10px)';
          }
        });

        setTimeout(() => {
          elements.photo.src = player.photo;
          elements.name.textContent = player.name;
          elements.rank.textContent = player.rank;
          elements.pp.textContent = player.pp;
          elements.chile.textContent = player.chile;
          elements.accuracy.textContent = player.accuracy;

          if (player.perfil) {
            socialContainers.perfil.style.display = 'block';
            elements.perfil.href = player.perfil;
          } else {
            socialContainers.perfil.style.display = 'none';
          }

          if (player.twitter) {
            socialContainers.twitter.style.display = 'block';
            elements.twitter.href = player.twitter;
          } else {
            socialContainers.twitter.style.display = 'none';
          }

          if (player.twitch) {
            socialContainers.twitch.style.display = 'block';
            elements.twitch.href = player.twitch;
          } else {
            socialContainers.twitch.style.display = 'none';
          }

          Object.values(elements).forEach((el, index) => {
            if (el) {
              setTimeout(() => {
                el.style.transition = 'all 0.3s ease';
                el.style.opacity = '1';
                if (el.id === 'selectedPlayerName') {
                  el.style.transform = 'translateY(0) rotate(-3deg)';
                } else {
                  el.style.transform = 'translateY(0)';
                }
              }, index * 50);
            }
          });
        }, 150);
      }
    });
  });
</script>